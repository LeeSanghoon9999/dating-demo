var $=Object.defineProperty,K=Object.defineProperties;var j=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var V=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable;var z=(a,i,e)=>i in a?$(a,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[i]=e,v=(a,i)=>{for(var e in i||(i={}))V.call(i,e)&&z(a,e,i[e]);if(M)for(var e of M(i))F.call(i,e)&&z(a,e,i[e]);return a},T=(a,i)=>K(a,j(i));function g(a,i){return a.filter(e=>e.name===i)}function R(a,i,e){let P=e(a),h=e(i);return P<h?-1:P===h?0:1}function H(a,i){return a.map((e,P)=>i(e)?P:void 0).filter(e=>typeof e=="number")}var b=new Map;function w(){let a=new Date().getTime().toString(),i=b.get(a),e=i!==void 0?i+1:0;return e===0&&(b=new Map),b.set(a,e),Number(`${a}${e.toString().padStart(2,"0")}`).toString(16)}function I(a){return a.length===0?void 0:a[a.length-1]}function C(a,i){let e=v({},a);return i.forEach(P=>{delete e[P]}),e}function L(a){let i=!1;return()=>{i||(i=!0,a())}}function _(a,i){let e=new Map;return[...a].reverse().filter(P=>{let h=i(P);if(h===null)return!0;let E=!!e.get(h);return e.set(h,!0),!E}).reverse()}function D(a,i){return T(v({id:w(),eventDate:new Date().getTime()},i),{name:a})}function q(a){if(a.length===0)throw new Error("events parameter is empty");let i=g(a,"Initialized"),e=g(a,"ActivityRegistered"),P=g(a,"Pushed");if(i.length>1)throw new Error("InitializedEvent can only exist once");let h=e.map(E=>E.activityName);P.forEach(E=>{if(!h.includes(E.activityName))throw new Error("the corresponding activity does not exist")})}function B(a,i){let e=_([...a].sort((t,y)=>R(t,y,o=>o.id)),t=>t.id);q(e);let P=g(e,"Initialized")[0],h=g(a,"ActivityRegistered"),{transitionDuration:E}=P,f=[];e.forEach(t=>{var y;switch(t.name){case"Pushed":{let o=t.skipEnterActiveState||i-t.eventDate>=E?"enter-done":"enter-active";f.push({id:t.activityId,name:t.activityName,transitionState:o,params:t.activityParams,context:t.activityContext,steps:[{id:t.activityId,params:t.activityParams,pushedBy:t}],pushedBy:t,metadata:{poppedBy:null},isTop:!1,isActive:!1,zIndex:-1});break}case"Replaced":{let o=I(H(f,S=>S.id===t.activityId)),c=typeof o=="number"?f[o]:void 0,s=c?c.transitionState:t.skipEnterActiveState||i-t.eventDate>=E?"enter-done":"enter-active",l={id:t.activityId,name:t.activityName,transitionState:s,params:t.activityParams,context:t.activityContext,steps:[{id:t.activityId,params:t.activityParams,pushedBy:t}],pushedBy:t,metadata:{poppedBy:null},isTop:!1,isActive:!1,zIndex:-1};if(typeof o=="number")f[o]=l;else{let S=f.filter(x=>x.metadata.poppedBy===null).sort((x,k)=>k.pushedBy.eventDate-x.pushedBy.eventDate)[0];f.push(l),S&&s==="enter-done"&&(S.metadata.poppedBy=t,S.transitionState="exit-done")}break}case"Popped":{let o=f.filter((s,l)=>l>0).filter(s=>s.metadata.poppedBy===null).sort((s,l)=>l.pushedBy.eventDate-s.pushedBy.eventDate)[0],c=t.skipExitActiveState||i-t.eventDate>=E?"exit-done":"exit-active";o&&(o.metadata.poppedBy=t,o.transitionState=c,c==="exit-done"&&(o.params=o.steps[0].params,o.steps=[o.steps[0]]));break}case"StepPushed":{let o=f.filter(c=>c.metadata.poppedBy===null).sort((c,s)=>s.pushedBy.eventDate-c.pushedBy.eventDate)[0];if(o){let c={id:t.stepId,params:t.stepParams,pushedBy:t};o.params=t.stepParams,o.steps=o.steps?[...o.steps,c]:[c]}break}case"StepReplaced":{let o=f.filter(c=>c.metadata.poppedBy===null).sort((c,s)=>s.pushedBy.eventDate-c.pushedBy.eventDate)[0];if(o){o.params=t.stepParams;let c={id:t.stepId,params:t.stepParams,pushedBy:t};o.steps.pop(),o.steps=[...o.steps,c]}break}case"StepPopped":{let o=f.filter(c=>c.metadata.poppedBy===null).sort((c,s)=>s.pushedBy.eventDate-c.pushedBy.eventDate)[0];if(o&&o.steps.length>1){o.steps.pop();let c=(y=I(o.steps))==null?void 0:y.params;c&&(o.params=c)}break}default:break}});let d=_(f,t=>t.id),n=d.filter(t=>t.transitionState==="enter-active"||t.transitionState==="enter-done"||t.transitionState==="exit-active"),A=n.filter(t=>t.transitionState==="enter-active"||t.transitionState==="enter-done"),u=n[n.length-1],r=A[A.length-1],m=f.find(t=>t.transitionState==="enter-active"||t.transitionState==="exit-active")?"loading":"idle";return{activities:d.map(t=>v({id:t.id,name:t.name,transitionState:t.transitionState,params:t.params,steps:t.steps,pushedBy:t.pushedBy,isTop:(u==null?void 0:u.id)===t.id,isActive:(r==null?void 0:r.id)===t.id,zIndex:n.findIndex(({id:y})=>y===t.id)},t.context?{context:t.context}:null)).sort((t,y)=>R(t,y,o=>o.id)),registeredActivities:h.map(t=>v({name:t.activityName},t.activityParamsSchema?{paramsSchema:t.activityParamsSchema}:null)),transitionDuration:E,globalTransitionState:m}}import J from"react-fast-compare";import U from"react-fast-compare";function O(a,i){var h,E;let e=[];!U(a,i)&&e.push({_TAG:"%SOMETHING_CHANGED%"});for(let f=0;f<Math.max(a.activities.length,i.activities.length);f+=1){let d=a.activities[f],n=i.activities[f],A=(d==null?void 0:d.transitionState)==="exit-done"||(d==null?void 0:d.transitionState)==="exit-active",u=(n==null?void 0:n.transitionState)==="enter-active"||(n==null?void 0:n.transitionState)==="enter-done";if(d&&n&&d.id===n.id)for(let r=0;r<Math.max(((h=d.steps)!=null?h:[]).length,((E=n.steps)!=null?E:[]).length);r+=1){let m=d.steps[r],p=n.steps[r];!m&&p?e.push({_TAG:"STEP_PUSHED",activity:n,step:p}):m&&!p?e.push({_TAG:"STEP_POPPED",activity:n}):d.steps.length===n.steps.length&&m.id!==p.id&&e.push({_TAG:"STEP_REPLACED",activity:n,step:p})}!d&&n?e.push({_TAG:n.pushedBy.name==="Pushed"?"PUSHED":"REPLACED",activity:n}):A&&u?e.push({_TAG:n.pushedBy.name==="Pushed"?"PUSHED":"REPLACED",activity:n}):d&&n&&d.id===n.id&&!U(C(d,["isActive","isTop","transitionState","zIndex"]),C(n,["isActive","isTop","transitionState","zIndex"]))&&n.pushedBy.name==="Replaced"&&e.push({_TAG:"REPLACED",activity:n})}for(let f=Math.max(a.activities.length,i.activities.length)-1;f>=0;f-=1){let d=a.activities[f],n=i.activities[f],A=(d==null?void 0:d.transitionState)==="enter-done"||(d==null?void 0:d.transitionState)==="enter-active",u=(n==null?void 0:n.transitionState)==="exit-active"||(n==null?void 0:n.transitionState)==="exit-done";A&&u&&e.push({_TAG:"POPPED",activity:n})}return e}var Q=1e3,W=Q/60;function Ot(a){let i={value:[...a.initialEvents]},e={value:B(i.value,new Date().getTime())},P=[],E=[(()=>({key:"@stackflow/core",onChanged(){P.forEach(r=>r())}}))(),...a.plugins.map(r=>r())],f=r=>{let m=O(e.value,r);e.value=r,A(m,E)},d=(r,m)=>{let p=D(r,m),t=B([...i.value,p],new Date().getTime());i.value.push(p),f(t);let y=setInterval(()=>{let o=B(i.value,new Date().getTime());J(e.value,o)||f(o),o.globalTransitionState==="idle"&&clearInterval(y)},W)};function n(r,m){let p=!1,t=v({},r);function y(s){let l=v({},s);return delete l.name,l}let o=()=>{p=!0},c=s=>{t=v(v({},t),s)};return m.forEach(s=>{var l,S,x,k,N,G;switch(t.name){case"Pushed":{(l=s.onBeforePush)==null||l.call(s,{actionParams:v({},t),actions:T(v({},u),{preventDefault:o,overrideActionParams:c})});break}case"Replaced":{(S=s.onBeforeReplace)==null||S.call(s,{actionParams:v({},t),actions:T(v({},u),{preventDefault:o,overrideActionParams:c})});break}case"Popped":{(x=s.onBeforePop)==null||x.call(s,{actionParams:v({},t),actions:T(v({},u),{preventDefault:o,overrideActionParams:c})});break}case"StepPushed":{(k=s.onBeforeStepPush)==null||k.call(s,{actionParams:v({},t),actions:T(v({},u),{preventDefault:o,overrideActionParams:c})});break}case"StepReplaced":{(N=s.onBeforeStepReplace)==null||N.call(s,{actionParams:v({},t),actions:T(v({},u),{preventDefault:o,overrideActionParams:c})});break}case"StepPopped":{(G=s.onBeforeStepPop)==null||G.call(s,{actionParams:v({},t),actions:T(v({},u),{preventDefault:o,overrideActionParams:c})});break}default:break}}),{isPrevented:p,overriddenParams:y(t)}}function A(r,m){r.forEach(p=>{m.forEach(t=>{var y,o,c,s,l,S,x;switch(p._TAG){case"PUSHED":return(y=t.onPushed)==null?void 0:y.call(t,{actions:u,effect:p});case"REPLACED":return(o=t.onReplaced)==null?void 0:o.call(t,{actions:u,effect:p});case"POPPED":return(c=t.onPopped)==null?void 0:c.call(t,{actions:u,effect:p});case"STEP_PUSHED":return(s=t.onStepPushed)==null?void 0:s.call(t,{actions:u,effect:p});case"STEP_REPLACED":return(l=t.onStepReplaced)==null?void 0:l.call(t,{actions:u,effect:p});case"STEP_POPPED":return(S=t.onStepPopped)==null?void 0:S.call(t,{actions:u,effect:p});case"%SOMETHING_CHANGED%":return(x=t.onChanged)==null?void 0:x.call(t,{actions:u,effect:p});default:return}})})}let u={getStack(){return e.value},dispatchEvent:d,push(r){let{isPrevented:m,overriddenParams:p}=n(D("Pushed",r),E);m||d("Pushed",p)},replace(r){let{isPrevented:m,overriddenParams:p}=n(D("Replaced",r),E);m||d("Replaced",p)},pop(r){let{isPrevented:m,overriddenParams:p}=n(D("Popped",r!=null?r:{}),E);m||d("Popped",p)},stepPush(r){let{isPrevented:m,overriddenParams:p}=n(D("StepPushed",r!=null?r:{}),E);m||d("StepPushed",p)},stepReplace(r){let{isPrevented:m,overriddenParams:p}=n(D("StepReplaced",r!=null?r:{}),E);m||d("StepReplaced",p)},stepPop(r){let{isPrevented:m,overriddenParams:p}=n(D("StepPopped",r!=null?r:{}),E);m||d("StepPopped",p)}};return{actions:u,init:L(()=>{E.forEach(r=>{var m;(m=r.onInit)==null||m.call(r,{actions:u})})}),subscribe(r){return P.push(r),function(){let p=P.findIndex(t=>t===r);p>-1&&P.splice(p,1)}}}}export{B as aggregate,Ot as createCoreStore,w as id,D as makeEvent,O as produceEffects};
//# sourceMappingURL=index.mjs.map
