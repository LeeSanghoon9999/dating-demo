"use strict";var J=Object.create;var k=Object.defineProperty,Q=Object.defineProperties,W=Object.getOwnPropertyDescriptor,X=Object.getOwnPropertyDescriptors,Y=Object.getOwnPropertyNames,H=Object.getOwnPropertySymbols,Z=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty,tt=Object.prototype.propertyIsEnumerable;var L=(e,o,a)=>o in e?k(e,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[o]=a,v=(e,o)=>{for(var a in o||(o={}))q.call(o,a)&&L(e,a,o[a]);if(H)for(var a of H(o))tt.call(o,a)&&L(e,a,o[a]);return e},D=(e,o)=>Q(e,X(o));var et=(e,o)=>{for(var a in o)k(e,a,{get:o[a],enumerable:!0})},U=(e,o,a,P)=>{if(o&&typeof o=="object"||typeof o=="function")for(let y of Y(o))!q.call(e,y)&&y!==a&&k(e,y,{get:()=>o[y],enumerable:!(P=W(o,y))||P.enumerable});return e};var $=(e,o,a)=>(a=e!=null?J(Z(e)):{},U(o||!e||!e.__esModule?k(a,"default",{value:e,enumerable:!0}):a,e)),ot=e=>U(k({},"__esModule",{value:!0}),e);var nt={};et(nt,{aggregate:()=>B,createCoreStore:()=>it,id:()=>b,makeEvent:()=>x,produceEffects:()=>w});module.exports=ot(nt);function g(e,o){return e.filter(a=>a.name===o)}function I(e,o,a){let P=a(e),y=a(o);return P<y?-1:P===y?0:1}function K(e,o){return e.map((a,P)=>o(a)?P:void 0).filter(a=>typeof a=="number")}var C=new Map;function b(){let e=new Date().getTime().toString(),o=C.get(e),a=o!==void 0?o+1:0;return a===0&&(C=new Map),C.set(e,a),Number(`${e}${a.toString().padStart(2,"0")}`).toString(16)}function _(e){return e.length===0?void 0:e[e.length-1]}function O(e,o){let a=v({},e);return o.forEach(P=>{delete a[P]}),a}function j(e){let o=!1;return()=>{o||(o=!0,e())}}function N(e,o){let a=new Map;return[...e].reverse().filter(P=>{let y=o(P);if(y===null)return!0;let E=!!a.get(y);return a.set(y,!0),!E}).reverse()}function x(e,o){return D(v({id:b(),eventDate:new Date().getTime()},o),{name:e})}function V(e){if(e.length===0)throw new Error("events parameter is empty");let o=g(e,"Initialized"),a=g(e,"ActivityRegistered"),P=g(e,"Pushed");if(o.length>1)throw new Error("InitializedEvent can only exist once");let y=a.map(E=>E.activityName);P.forEach(E=>{if(!y.includes(E.activityName))throw new Error("the corresponding activity does not exist")})}function B(e,o){let a=N([...e].sort((t,l)=>I(t,l,r=>r.id)),t=>t.id);V(a);let P=g(a,"Initialized")[0],y=g(e,"ActivityRegistered"),{transitionDuration:E}=P,f=[];a.forEach(t=>{var l;switch(t.name){case"Pushed":{let r=t.skipEnterActiveState||o-t.eventDate>=E?"enter-done":"enter-active";f.push({id:t.activityId,name:t.activityName,transitionState:r,params:t.activityParams,context:t.activityContext,steps:[{id:t.activityId,params:t.activityParams,pushedBy:t}],pushedBy:t,metadata:{poppedBy:null},isTop:!1,isActive:!1,zIndex:-1});break}case"Replaced":{let r=_(K(f,S=>S.id===t.activityId)),c=typeof r=="number"?f[r]:void 0,s=c?c.transitionState:t.skipEnterActiveState||o-t.eventDate>=E?"enter-done":"enter-active",h={id:t.activityId,name:t.activityName,transitionState:s,params:t.activityParams,context:t.activityContext,steps:[{id:t.activityId,params:t.activityParams,pushedBy:t}],pushedBy:t,metadata:{poppedBy:null},isTop:!1,isActive:!1,zIndex:-1};if(typeof r=="number")f[r]=h;else{let S=f.filter(T=>T.metadata.poppedBy===null).sort((T,R)=>R.pushedBy.eventDate-T.pushedBy.eventDate)[0];f.push(h),S&&s==="enter-done"&&(S.metadata.poppedBy=t,S.transitionState="exit-done")}break}case"Popped":{let r=f.filter((s,h)=>h>0).filter(s=>s.metadata.poppedBy===null).sort((s,h)=>h.pushedBy.eventDate-s.pushedBy.eventDate)[0],c=t.skipExitActiveState||o-t.eventDate>=E?"exit-done":"exit-active";r&&(r.metadata.poppedBy=t,r.transitionState=c,c==="exit-done"&&(r.params=r.steps[0].params,r.steps=[r.steps[0]]));break}case"StepPushed":{let r=f.filter(c=>c.metadata.poppedBy===null).sort((c,s)=>s.pushedBy.eventDate-c.pushedBy.eventDate)[0];if(r){let c={id:t.stepId,params:t.stepParams,pushedBy:t};r.params=t.stepParams,r.steps=r.steps?[...r.steps,c]:[c]}break}case"StepReplaced":{let r=f.filter(c=>c.metadata.poppedBy===null).sort((c,s)=>s.pushedBy.eventDate-c.pushedBy.eventDate)[0];if(r){r.params=t.stepParams;let c={id:t.stepId,params:t.stepParams,pushedBy:t};r.steps.pop(),r.steps=[...r.steps,c]}break}case"StepPopped":{let r=f.filter(c=>c.metadata.poppedBy===null).sort((c,s)=>s.pushedBy.eventDate-c.pushedBy.eventDate)[0];if(r&&r.steps.length>1){r.steps.pop();let c=(l=_(r.steps))==null?void 0:l.params;c&&(r.params=c)}break}default:break}});let d=N(f,t=>t.id),n=d.filter(t=>t.transitionState==="enter-active"||t.transitionState==="enter-done"||t.transitionState==="exit-active"),A=n.filter(t=>t.transitionState==="enter-active"||t.transitionState==="enter-done"),u=n[n.length-1],i=A[A.length-1],m=f.find(t=>t.transitionState==="enter-active"||t.transitionState==="exit-active")?"loading":"idle";return{activities:d.map(t=>v({id:t.id,name:t.name,transitionState:t.transitionState,params:t.params,steps:t.steps,pushedBy:t.pushedBy,isTop:(u==null?void 0:u.id)===t.id,isActive:(i==null?void 0:i.id)===t.id,zIndex:n.findIndex(({id:l})=>l===t.id)},t.context?{context:t.context}:null)).sort((t,l)=>I(t,l,r=>r.id)),registeredActivities:y.map(t=>v({name:t.activityName},t.activityParamsSchema?{paramsSchema:t.activityParamsSchema}:null)),transitionDuration:E,globalTransitionState:m}}var F=$(require("react-fast-compare"));var G=$(require("react-fast-compare"));function w(e,o){var y,E;let a=[];!(0,G.default)(e,o)&&a.push({_TAG:"%SOMETHING_CHANGED%"});for(let f=0;f<Math.max(e.activities.length,o.activities.length);f+=1){let d=e.activities[f],n=o.activities[f],A=(d==null?void 0:d.transitionState)==="exit-done"||(d==null?void 0:d.transitionState)==="exit-active",u=(n==null?void 0:n.transitionState)==="enter-active"||(n==null?void 0:n.transitionState)==="enter-done";if(d&&n&&d.id===n.id)for(let i=0;i<Math.max(((y=d.steps)!=null?y:[]).length,((E=n.steps)!=null?E:[]).length);i+=1){let m=d.steps[i],p=n.steps[i];!m&&p?a.push({_TAG:"STEP_PUSHED",activity:n,step:p}):m&&!p?a.push({_TAG:"STEP_POPPED",activity:n}):d.steps.length===n.steps.length&&m.id!==p.id&&a.push({_TAG:"STEP_REPLACED",activity:n,step:p})}!d&&n?a.push({_TAG:n.pushedBy.name==="Pushed"?"PUSHED":"REPLACED",activity:n}):A&&u?a.push({_TAG:n.pushedBy.name==="Pushed"?"PUSHED":"REPLACED",activity:n}):d&&n&&d.id===n.id&&!(0,G.default)(O(d,["isActive","isTop","transitionState","zIndex"]),O(n,["isActive","isTop","transitionState","zIndex"]))&&n.pushedBy.name==="Replaced"&&a.push({_TAG:"REPLACED",activity:n})}for(let f=Math.max(e.activities.length,o.activities.length)-1;f>=0;f-=1){let d=e.activities[f],n=o.activities[f],A=(d==null?void 0:d.transitionState)==="enter-done"||(d==null?void 0:d.transitionState)==="enter-active",u=(n==null?void 0:n.transitionState)==="exit-active"||(n==null?void 0:n.transitionState)==="exit-done";A&&u&&a.push({_TAG:"POPPED",activity:n})}return a}var at=1e3,rt=at/60;function it(e){let o={value:[...e.initialEvents]},a={value:B(o.value,new Date().getTime())},P=[],E=[(()=>({key:"@stackflow/core",onChanged(){P.forEach(i=>i())}}))(),...e.plugins.map(i=>i())],f=i=>{let m=w(a.value,i);a.value=i,A(m,E)},d=(i,m)=>{let p=x(i,m),t=B([...o.value,p],new Date().getTime());o.value.push(p),f(t);let l=setInterval(()=>{let r=B(o.value,new Date().getTime());(0,F.default)(a.value,r)||f(r),r.globalTransitionState==="idle"&&clearInterval(l)},rt)};function n(i,m){let p=!1,t=v({},i);function l(s){let h=v({},s);return delete h.name,h}let r=()=>{p=!0},c=s=>{t=v(v({},t),s)};return m.forEach(s=>{var h,S,T,R,M,z;switch(t.name){case"Pushed":{(h=s.onBeforePush)==null||h.call(s,{actionParams:v({},t),actions:D(v({},u),{preventDefault:r,overrideActionParams:c})});break}case"Replaced":{(S=s.onBeforeReplace)==null||S.call(s,{actionParams:v({},t),actions:D(v({},u),{preventDefault:r,overrideActionParams:c})});break}case"Popped":{(T=s.onBeforePop)==null||T.call(s,{actionParams:v({},t),actions:D(v({},u),{preventDefault:r,overrideActionParams:c})});break}case"StepPushed":{(R=s.onBeforeStepPush)==null||R.call(s,{actionParams:v({},t),actions:D(v({},u),{preventDefault:r,overrideActionParams:c})});break}case"StepReplaced":{(M=s.onBeforeStepReplace)==null||M.call(s,{actionParams:v({},t),actions:D(v({},u),{preventDefault:r,overrideActionParams:c})});break}case"StepPopped":{(z=s.onBeforeStepPop)==null||z.call(s,{actionParams:v({},t),actions:D(v({},u),{preventDefault:r,overrideActionParams:c})});break}default:break}}),{isPrevented:p,overriddenParams:l(t)}}function A(i,m){i.forEach(p=>{m.forEach(t=>{var l,r,c,s,h,S,T;switch(p._TAG){case"PUSHED":return(l=t.onPushed)==null?void 0:l.call(t,{actions:u,effect:p});case"REPLACED":return(r=t.onReplaced)==null?void 0:r.call(t,{actions:u,effect:p});case"POPPED":return(c=t.onPopped)==null?void 0:c.call(t,{actions:u,effect:p});case"STEP_PUSHED":return(s=t.onStepPushed)==null?void 0:s.call(t,{actions:u,effect:p});case"STEP_REPLACED":return(h=t.onStepReplaced)==null?void 0:h.call(t,{actions:u,effect:p});case"STEP_POPPED":return(S=t.onStepPopped)==null?void 0:S.call(t,{actions:u,effect:p});case"%SOMETHING_CHANGED%":return(T=t.onChanged)==null?void 0:T.call(t,{actions:u,effect:p});default:return}})})}let u={getStack(){return a.value},dispatchEvent:d,push(i){let{isPrevented:m,overriddenParams:p}=n(x("Pushed",i),E);m||d("Pushed",p)},replace(i){let{isPrevented:m,overriddenParams:p}=n(x("Replaced",i),E);m||d("Replaced",p)},pop(i){let{isPrevented:m,overriddenParams:p}=n(x("Popped",i!=null?i:{}),E);m||d("Popped",p)},stepPush(i){let{isPrevented:m,overriddenParams:p}=n(x("StepPushed",i!=null?i:{}),E);m||d("StepPushed",p)},stepReplace(i){let{isPrevented:m,overriddenParams:p}=n(x("StepReplaced",i!=null?i:{}),E);m||d("StepReplaced",p)},stepPop(i){let{isPrevented:m,overriddenParams:p}=n(x("StepPopped",i!=null?i:{}),E);m||d("StepPopped",p)}};return{actions:u,init:j(()=>{E.forEach(i=>{var m;(m=i.onInit)==null||m.call(i,{actions:u})})}),subscribe(i){return P.push(i),function(){let p=P.findIndex(t=>t===i);p>-1&&P.splice(p,1)}}}}
//# sourceMappingURL=index.js.map
