var Q=Object.defineProperty,V=Object.defineProperties;var W=Object.getOwnPropertyDescriptors;var G=Object.getOwnPropertySymbols;var J=Object.prototype.hasOwnProperty,X=Object.prototype.propertyIsEnumerable;var I=(t,n,i)=>n in t?Q(t,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[n]=i,o=(t,n)=>{for(var i in n||(n={}))J.call(n,i)&&I(t,i,n[i]);if(G)for(var i of G(n))X.call(n,i)&&I(t,i,n[i]);return t},m=(t,n)=>V(t,W(n));import{id as M,makeEvent as K}from"@stackflow/core";import j from"react";function H(t){return t.length===0?void 0:t[t.length-1]}import Y from"url-pattern";function Z(t){return new URL(t,"file://")}function tt(t){let n={};return t.forEach((i,e)=>{n[e]=i}),n}function et(t){return t.endsWith("/")?t:`${t}/`}function nt(t){return t.toString().length>0?`?${t}`:t}function l(t){let n=new Y(`${t}(/)`);return{fill(i){var u;let e=n.stringify(i),s=(u=n.match(e))!=null?u:{},a=o({},i);Object.keys(s).forEach(p=>{delete a[p]});let c=new URLSearchParams(a);return et(e)+nt(c)},parse(i){let e=Z(i),s=n.match(e.pathname),a=tt(e.searchParams);return s?o(o({},a),s):null}}}function f(t){return typeof t=="string"?[t]:t}import rt,{createContext as st,useContext as it}from"react";var U=st({}),$=t=>rt.createElement(U.Provider,{value:t.routes},t.children);function at(){return it(U)}var g="@stackflow/plugin-history-sync@0.16.0",ot=1e3,O=60*ot,R=typeof window=="undefined";function F(){return R?null:window.history.state}function b(t){let n=t;return typeof n=="object"&&n!==null&&"_TAG"in n&&typeof n._TAG=="string"&&n._TAG===g?t:null}function D({state:t,url:n,useHash:i}){if(R)return;let e=i?`${window.location.pathname}#${n}`:n;window.history.pushState(t,"",e)}function E({url:t,state:n,useHash:i}){if(R)return;let e=i?`${window.location.pathname}#${t}`:t;window.history.replaceState(n,"",e)}function A(t){return m(o({},t),{context:void 0,pushedBy:m(o({},t.pushedBy),{activityContext:void 0})})}var L,St=(L=j.startTransition)!=null?L:t=>t();function At(t){return()=>{let n=0,i=0;return{key:"plugin-history-sync",wrapStack({stack:e}){return j.createElement($,{routes:t.routes},e.render())},overrideInitialEvents({initialContext:e}){var v,P;let s=b(F());if(s)return[m(o({},s.activity.pushedBy),{name:"Pushed"}),...((v=s.step)==null?void 0:v.pushedBy.name)==="StepPushed"||((P=s.step)==null?void 0:P.pushedBy.name)==="StepReplaced"?[m(o({},s.step.pushedBy),{name:"StepPushed"})]:[]];function a(){var r,y;return((r=e==null?void 0:e.req)==null?void 0:r.path)&&typeof e.req.path=="string"?e.req.path:R?null:t.useHash?(y=window.location.hash.split("#")[1])!=null?y:"/":window.location.pathname+window.location.search}let c=a(),u=Object.keys(t.routes);if(c)for(let r=0;r<u.length;r+=1){let y=u[r],d=f(t.routes[y]);for(let h=0;h<d.length;h+=1){let B=d[h],k=l(B).parse(c);if(!!k){let x=M();return[K("Pushed",{activityId:x,activityName:y,activityParams:o({},k),eventDate:new Date().getTime()-O,activityContext:{path:c}})]}}}let p=M(),T=t.fallbackActivity({initialContext:e}),w=f(t.routes[T])[0];return[K("Pushed",{activityId:p,activityName:T,activityParams:{},eventDate:new Date().getTime()-O,activityContext:{path:w}})]},onInit({actions:{getStack:e,dispatchEvent:s,push:a,stepPush:c}}){let u=e().activities[0],p=l(f(t.routes[u.name])[0]);window.getStack=e,E({url:p.fill(u.params),state:{_TAG:g,activity:A(u),step:H(u.steps)},useHash:t.useHash});let T=N=>{if(i){i-=1;return}let w=b(N.state);if(!w)return;let v=w.activity,P=w.activity.id,r=w.step,{activities:y}=e(),d=y.find(S=>S.isActive);if(!d)return;let h=H(d.steps),B=y.find(S=>S.id===P),_=d.steps.find(S=>S.id===(r==null?void 0:r.id)),k=()=>d.id>P,C=()=>d.id<P,x=()=>d.id===P,q=()=>x()?!!(!r||h&&h.id>r.id):!1,z=()=>x()?!!(!h||r&&h.id<r.id):!1;if(k()&&(s("Popped",{}),B||(n+=1,a(o({},v.pushedBy)),((r==null?void 0:r.pushedBy.name)==="StepPushed"||(r==null?void 0:r.pushedBy.name)==="StepReplaced")&&(n+=1,c(o({},r.pushedBy))))),q()&&(!_&&r&&((r==null?void 0:r.pushedBy.name)==="StepPushed"||(r==null?void 0:r.pushedBy.name)==="StepReplaced")&&(n+=1,c(o({},r.pushedBy))),s("StepPopped",{})),C()&&(n+=1,a({activityId:v.id,activityName:v.name,activityParams:v.params})),z()){if(!r)return;n+=1,c({stepId:r.id,stepParams:r.params})}};R||window.addEventListener("popstate",T)},onPushed({effect:{activity:e}}){if(n){n-=1;return}let s=l(f(t.routes[e.name])[0]);D({url:s.fill(e.params),state:{_TAG:g,activity:A(e)},useHash:t.useHash})},onStepPushed({effect:{activity:e,step:s}}){if(n){n-=1;return}let a=l(f(t.routes[e.name])[0]);D({url:a.fill(e.params),state:{_TAG:g,activity:A(e),step:s},useHash:t.useHash})},onReplaced({effect:{activity:e}}){if(!e.isActive)return;let s=l(f(t.routes[e.name])[0]);E({url:s.fill(e.params),state:{_TAG:g,activity:A(e)},useHash:t.useHash})},onStepReplaced({effect:{activity:e,step:s}}){if(!e.isActive)return;let a=l(f(t.routes[e.name])[0]);E({url:a.fill(e.params),state:{_TAG:g,activity:A(e),step:s},useHash:t.useHash})},onBeforePush({actionParams:e,actions:{overrideActionParams:s}}){let c=l(f(t.routes[e.activityName])[0]).fill(e.activityParams);s(m(o({},e),{activityContext:m(o({},e.activityContext),{path:c})}))},onBeforeReplace({actionParams:e,actions:{overrideActionParams:s}}){let c=l(f(t.routes[e.activityName])[0]).fill(e.activityParams);s(m(o({},e),{activityContext:m(o({},e.activityContext),{path:c})}))},onBeforePop({actions:{getStack:e}}){var u;if(typeof window=="undefined")return;let{activities:s}=e(),a=s.find(p=>p.isActive),c=(u=a==null?void 0:a.steps.length)!=null?u:0;i+=c;do for(let p=0;p<c;p+=1)window.history.back();while(!b(F()))}}}}export{At as historySyncPlugin,l as makeTemplate,f as normalizeRoute,at as useRoutes};
//# sourceMappingURL=index.mjs.map
