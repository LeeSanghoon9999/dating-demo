"use strict";var Z=Object.create;var T=Object.defineProperty,tt=Object.defineProperties,et=Object.getOwnPropertyDescriptor,nt=Object.getOwnPropertyDescriptors,rt=Object.getOwnPropertyNames,K=Object.getOwnPropertySymbols,st=Object.getPrototypeOf,F=Object.prototype.hasOwnProperty,it=Object.prototype.propertyIsEnumerable;var O=(t,n,r)=>n in t?T(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r,o=(t,n)=>{for(var r in n||(n={}))F.call(n,r)&&O(t,r,n[r]);if(K)for(var r of K(n))it.call(n,r)&&O(t,r,n[r]);return t},m=(t,n)=>tt(t,nt(n));var at=(t,n)=>{for(var r in n)T(t,r,{get:n[r],enumerable:!0})},D=(t,n,r,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of rt(n))!F.call(t,s)&&s!==r&&T(t,s,{get:()=>n[s],enumerable:!(e=et(n,s))||e.enumerable});return t};var N=(t,n,r)=>(r=t!=null?Z(st(t)):{},D(n||!t||!t.__esModule?T(r,"default",{value:t,enumerable:!0}):r,t)),ot=t=>D(T({},"__esModule",{value:!0}),t);var mt={};at(mt,{historySyncPlugin:()=>dt,makeTemplate:()=>p,normalizeRoute:()=>f,useRoutes:()=>z});module.exports=ot(mt);var A=require("@stackflow/core"),I=N(require("react"));function _(t){return t.length===0?void 0:t[t.length-1]}var L=N(require("url-pattern"));function ct(t){return new URL(t,"file://")}function ut(t){let n={};return t.forEach((r,e)=>{n[e]=r}),n}function ft(t){return t.endsWith("/")?t:`${t}/`}function pt(t){return t.toString().length>0?`?${t}`:t}function p(t){let n=new L.default(`${t}(/)`);return{fill(r){var u;let e=n.stringify(r),s=(u=n.match(e))!=null?u:{},a=o({},r);Object.keys(s).forEach(l=>{delete a[l]});let c=new URLSearchParams(a);return ft(e)+pt(c)},parse(r){let e=ct(r),s=n.match(e.pathname),a=ut(e.searchParams);return s?o(o({},a),s):null}}}function f(t){return typeof t=="string"?[t]:t}var g=N(require("react")),j=(0,g.createContext)({}),q=t=>g.default.createElement(j.Provider,{value:t.routes},t.children);function z(){return(0,g.useContext)(j)}var S="@stackflow/plugin-history-sync@0.16.0",lt=1e3,Q=60*lt,x=typeof window=="undefined";function V(){return x?null:window.history.state}function C(t){let n=t;return typeof n=="object"&&n!==null&&"_TAG"in n&&typeof n._TAG=="string"&&n._TAG===S?t:null}function W({state:t,url:n,useHash:r}){if(x)return;let e=r?`${window.location.pathname}#${n}`:n;window.history.pushState(t,"",e)}function G({url:t,state:n,useHash:r}){if(x)return;let e=r?`${window.location.pathname}#${t}`:t;window.history.replaceState(n,"",e)}function k(t){return m(o({},t),{context:void 0,pushedBy:m(o({},t.pushedBy),{activityContext:void 0})})}var J,Tt=(J=I.default.startTransition)!=null?J:t=>t();function dt(t){return()=>{let n=0,r=0;return{key:"plugin-history-sync",wrapStack({stack:e}){return I.default.createElement(q,{routes:t.routes},e.render())},overrideInitialEvents({initialContext:e}){var v,P;let s=C(V());if(s)return[m(o({},s.activity.pushedBy),{name:"Pushed"}),...((v=s.step)==null?void 0:v.pushedBy.name)==="StepPushed"||((P=s.step)==null?void 0:P.pushedBy.name)==="StepReplaced"?[m(o({},s.step.pushedBy),{name:"StepPushed"})]:[]];function a(){var i,y;return((i=e==null?void 0:e.req)==null?void 0:i.path)&&typeof e.req.path=="string"?e.req.path:x?null:t.useHash?(y=window.location.hash.split("#")[1])!=null?y:"/":window.location.pathname+window.location.search}let c=a(),u=Object.keys(t.routes);if(c)for(let i=0;i<u.length;i+=1){let y=u[i],d=f(t.routes[y]);for(let h=0;h<d.length;h+=1){let E=d[h],H=p(E).parse(c);if(!!H){let b=(0,A.id)();return[(0,A.makeEvent)("Pushed",{activityId:b,activityName:y,activityParams:o({},H),eventDate:new Date().getTime()-Q,activityContext:{path:c}})]}}}let l=(0,A.id)(),B=t.fallbackActivity({initialContext:e}),w=f(t.routes[B])[0];return[(0,A.makeEvent)("Pushed",{activityId:l,activityName:B,activityParams:{},eventDate:new Date().getTime()-Q,activityContext:{path:w}})]},onInit({actions:{getStack:e,dispatchEvent:s,push:a,stepPush:c}}){let u=e().activities[0],l=p(f(t.routes[u.name])[0]);window.getStack=e,G({url:l.fill(u.params),state:{_TAG:S,activity:k(u),step:_(u.steps)},useHash:t.useHash});let B=U=>{if(r){r-=1;return}let w=C(U.state);if(!w)return;let v=w.activity,P=w.activity.id,i=w.step,{activities:y}=e(),d=y.find(R=>R.isActive);if(!d)return;let h=_(d.steps),E=y.find(R=>R.id===P),$=d.steps.find(R=>R.id===(i==null?void 0:i.id)),H=()=>d.id>P,M=()=>d.id<P,b=()=>d.id===P,X=()=>b()?!!(!i||h&&h.id>i.id):!1,Y=()=>b()?!!(!h||i&&h.id<i.id):!1;if(H()&&(s("Popped",{}),E||(n+=1,a(o({},v.pushedBy)),((i==null?void 0:i.pushedBy.name)==="StepPushed"||(i==null?void 0:i.pushedBy.name)==="StepReplaced")&&(n+=1,c(o({},i.pushedBy))))),X()&&(!$&&i&&((i==null?void 0:i.pushedBy.name)==="StepPushed"||(i==null?void 0:i.pushedBy.name)==="StepReplaced")&&(n+=1,c(o({},i.pushedBy))),s("StepPopped",{})),M()&&(n+=1,a({activityId:v.id,activityName:v.name,activityParams:v.params})),Y()){if(!i)return;n+=1,c({stepId:i.id,stepParams:i.params})}};x||window.addEventListener("popstate",B)},onPushed({effect:{activity:e}}){if(n){n-=1;return}let s=p(f(t.routes[e.name])[0]);W({url:s.fill(e.params),state:{_TAG:S,activity:k(e)},useHash:t.useHash})},onStepPushed({effect:{activity:e,step:s}}){if(n){n-=1;return}let a=p(f(t.routes[e.name])[0]);W({url:a.fill(e.params),state:{_TAG:S,activity:k(e),step:s},useHash:t.useHash})},onReplaced({effect:{activity:e}}){if(!e.isActive)return;let s=p(f(t.routes[e.name])[0]);G({url:s.fill(e.params),state:{_TAG:S,activity:k(e)},useHash:t.useHash})},onStepReplaced({effect:{activity:e,step:s}}){if(!e.isActive)return;let a=p(f(t.routes[e.name])[0]);G({url:a.fill(e.params),state:{_TAG:S,activity:k(e),step:s},useHash:t.useHash})},onBeforePush({actionParams:e,actions:{overrideActionParams:s}}){let c=p(f(t.routes[e.activityName])[0]).fill(e.activityParams);s(m(o({},e),{activityContext:m(o({},e.activityContext),{path:c})}))},onBeforeReplace({actionParams:e,actions:{overrideActionParams:s}}){let c=p(f(t.routes[e.activityName])[0]).fill(e.activityParams);s(m(o({},e),{activityContext:m(o({},e.activityContext),{path:c})}))},onBeforePop({actions:{getStack:e}}){var u;if(typeof window=="undefined")return;let{activities:s}=e(),a=s.find(l=>l.isActive),c=(u=a==null?void 0:a.steps.length)!=null?u:0;r+=c;do for(let l=0;l<c;l+=1)window.history.back();while(!C(V()))}}}}
//# sourceMappingURL=index.js.map
